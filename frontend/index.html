<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIP auth_web3 Module Demo</title>
  <link rel="stylesheet" href="styles.css">
  </head>
  <body>
  <div class="app" id="app">
    <!-- Auth Gate (shown when not logged in) -->
    <div id="auth-gate" style="display: none;">
      <div class="auth-container">
        <h1>Auth_web3 SIP Module Demo</h1>
        <p class="subtitle">Demonstrating blockchain-based SIP authentication with <code>auth_web3</code> module</p>
        
        <h2 class="what-will-you-do">What will you do?</h2>
        
        <div class="auth-steps">
          <div class="auth-step">
            <div class="step-number-circle">1</div>
            <div>
              <p class="step-text"><strong>Sign in to get started</strong></p>
              <p class="step-explanation">Your credentials will be based on your email, therefore we require you log in.</p>
            </div>
          </div>
          <div class="auth-step">
            <div class="step-number-circle">2</div>
            <div>
              <p class="step-text"><strong>Create credentials for free</strong></p>
              <p class="step-explanation">You'll receive them in your inbox</p>
            </div>
          </div>
          <div class="auth-step">
            <div class="step-number-circle">3</div>
            <div>
              <p class="step-text"><strong>Use them to register to our server</strong></p>
              <p class="step-explanation">At kama6.cellact.nl and make calls</p>
            </div>
          </div>
        </div>
        
        <p class="sign-in-label">Sign in with:</p>
        
        <button id="btn-google-signin" class="btn-google">
          <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
            <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
            <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
            <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
            <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
            <path fill="none" d="M0 0h48v48H0z"/>
          </svg>
          Google
        </button>
        
        <div class="auth-divider">
          <span>or</span>
        </div>
        
        <button id="btn-email-signin" class="btn-secondary-auth">
          üìß Email
        </button>
        <p class="auth-note-secondary">For non-Gmail accounts</p>
      </div>
    </div>

    <!-- Email Sign-In Modal -->
    <div id="email-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <h2>Sign in with Email</h2>
        <p>Enter your email address and we'll send you a secure sign-in link</p>
        <form id="email-signin-form">
          <input type="email" id="email-input" placeholder="your@email.com" required>
          <div class="modal-buttons">
            <button type="button" id="btn-cancel-email" class="btn-secondary">Cancel</button>
            <button type="submit" id="btn-send-link" class="btn-primary">Send Link</button>
          </div>
        </form>
        <div id="email-status" class="email-status" style="display: none;"></div>
      </div>
    </div>

    <!-- Main App (shown when logged in) -->
    <div id="main-app" style="display: none;">
      <header>
        <div class="header-left">
          <h1>SIP auth_web3 Module Demo</h1>
          <p class="header-subtitle">Blockchain-based SIP authentication via <code>auth_web3</code> module</p>
        </div>
        <div class="header-actions">
          <a href="https://github.com/cellact/authentication-demo-website" target="_blank" rel="noopener noreferrer" class="btn-github" title="View on GitHub">
            <svg height="20" width="20" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
            </svg>
            GitHub
          </a>
          <button id="btn-how-it-works" class="btn-info-header">How It Works</button>
          <span id="user-email" class="user-email"></span>
          <button id="btn-signout" class="btn-secondary">Sign Out</button>
        </div>
      </header>

    <main id="main-view">
      <!-- Error message -->
      <div id="error" class="error" style="display: none;"></div>

      <!-- Progressive Steps Panel -->
      <div class="panel">
        <div class="panel-header">
          <h2>Create Your Account</h2>
          <button id="btn-advanced-info" class="btn-info">Advanced Info</button>
        </div>

        <!-- Introduction Screen (shown first) -->
        <div id="intro-screen" class="intro-screen">
          <p><strong>What you will do?</strong> Create credentials for a SIP account that will be able to authenticate using the <code>auth_web3</code> module.</p>
          <p>You'll receive an <strong>Username</strong>, <strong>Auth Username</strong>, and <strong>Password</strong> via Gmail. Use these to register to <code>kama6.cellact.nl</code> (UDP transport) on any SIP client. Once registered, call other users or dial <code>asteriskTest</code> which is our IVR.</p>
          <button id="btn-start-process" class="btn-create" style="margin-top: 20px;">OK</button>
        </div>

        <!-- Steps Container (hidden initially) -->
        <div id="steps-container" style="display: none;">
        
        <div class="back-button-container">
          <button id="btn-back-to-intro" class="btn-secondary">‚Üê Back to Instructions</button>
        </div>

        <!-- Step 1: Your Credentials -->
        <div class="accordion-step" id="step-1" data-step="1">
          <div class="accordion-header" id="step-1-header">
            <div class="accordion-header-left">
              <div class="step-number">1</div>
              <h3>Your Credentials</h3>
            </div>
            <div class="step-status" id="step-1-status">Click to start</div>
          </div>
          <div class="accordion-content" id="step-1-content">
            <form id="add-user-form" class="form">
              <div class="username-display">
                <label>Your username will be:</label>
                <div class="generated-username" id="generated-username">-</div>
                <small class="username-note">Generated from your Google email</small>
              </div>
              <div>
                <label>Choose a password</label>
                <div class="password-input-wrapper">
                  <input type="password" id="password" name="password" required placeholder="Enter a password">
                  <button type="button" id="toggle-password" class="toggle-password" aria-label="Toggle password visibility">
                    üëÅÔ∏è
                  </button>
                </div>
                <small class="username-note">Account details will be sent to your Gmail</small>
              </div>
              
              <div class="credentials-explanation">
                <p><strong>You will receive via email:</strong></p>
                <ul>
                  <li><strong>Auth Username:</strong> Stored with your password on Oasis Sapphire, mapped to a blockchain wallet</li>
                  <li><strong>Password:</strong> Your chosen password</li>
                  <li><strong>Username/Display Name:</strong> An ENS subdomain (e.g., <code>yourname.demoauth.global</code>) owned by the blockchain wallet mapped to your auth username</li>
                </ul>
              </div>
              
              <div class="form-actions">
                <button type="submit" id="btn-submit" class="btn-create">Create Account</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Step 2: Getting Your Credentials -->
        <div class="accordion-step locked" id="step-2" data-step="2">
          <div class="accordion-header" id="step-2-header">
            <div class="accordion-header-left">
              <div class="step-number">2</div>
              <h3>Getting Your Credentials</h3>
            </div>
            <div class="step-status" id="step-2-status">Locked</div>
          </div>
          <div class="accordion-content" id="step-2-content">
            <!-- Loading status indicator -->
            <div id="creation-status" class="creation-status">
              <div class="spinner"></div>
              <div class="status-text">
                <p><strong>Creating your account...</strong></p>
                <p>Storing credentials on Oasis Sapphire and registering ENS identity on Hoodi. Your credentials will be sent to your Gmail shortly.</p>
              </div>
            </div>
            
            <!-- Success message -->
            <div id="success-status" class="success-status" style="display: none;">
              <div class="success-icon">Done</div>
              <div class="status-text">
                <p><strong>Account created successfully!</strong></p>
                <p>Your credentials have been sent to your email. Check your inbox (and spam folder) for the full details.</p>
              </div>
              <button id="btn-continue-step3" class="btn-create" style="display: none; margin-top: 20px;" onclick="continueToStep3()">Continue to Next Step</button>
            </div>
          </div>
        </div>

        <!-- Step 3: Using Your Credentials -->
        <div class="accordion-step locked" id="step-3" data-step="3">
          <div class="accordion-header" id="step-3-header">
            <div class="accordion-header-left">
              <div class="step-number">3</div>
              <h3>Using Your Credentials</h3>
            </div>
            <div class="step-status" id="step-3-status">Locked</div>
          </div>
          <div class="accordion-content" id="step-3-content">
            <p>Register to <code>kama6.cellact.nl</code> with <strong>UDP transport</strong> on any SIP client using your credentials.</p>
            <p><strong>What you can do:</strong></p>
            <ul>
              <li>Call any other registered user</li>
              <li>Call our IVR at <code>asteriskTest</code> if you only have one device</li>
            </ul>
          </div>
        </div>

        </div><!-- End of steps-container -->
      </div>
    </main>

    <!-- How It Works Page -->
    <main id="how-it-works-view" style="display: none;">
      <div class="panel">
        <div class="back-button-container">
          <button id="btn-back-to-main" class="btn-secondary">‚Üê Back to Main</button>
        </div>
        <h2>How It Works - Implementation Guide</h2>
        
        <h3>What's Happening Behind the Scenes</h3>
        <p>When you create an account:</p>
        <ul>
          <li>Your credentials are stored in a <strong>confidential smart contract</strong> on Oasis Sapphire (an EVM blockchain with built-in encryption)</li>
          <li>An <strong>ENS identity</strong> is registered on the Hoodi network, linking your username to a wallet address</li>
          <li>When you authenticate via SIP, the Kamailio server queries these blockchain contracts to verify your credentials</li>
        </ul>

        <h3>How to Use This in Your Own Kamailio Setup</h3>
        
        <h4>1. Load the auth_web3 module:</h4>
        <pre><code>loadmodule "auth_web3.so"</code></pre>

        <h4>2. Configure module parameters:</h4>
        <pre><code># Point to your authentication contract on Oasis Sapphire
modparam("auth_web3", "authentication_contract_address", "0xYourContractAddress")
modparam("auth_web3", "authentication_rpc_url", "https://testnet.sapphire.oasis.dev")

# Optional: Enable ENS resolution on Hoodi (or any ENS-compatible network)
modparam("auth_web3", "ens_rpc_url", "https://rpc.hoodi.ethpandaops.io")
modparam("auth_web3", "ens_registry_address", "0x5841d17010252BE760D055cba2f2853874457443")

# Adjust timeout for blockchain queries
modparam("auth_web3", "rpc_timeout", 40)</code></pre>

        <h4>3. Use in your routing logic:</h4>
        <pre><code>route[AUTH] {
    if (is_method("REGISTER")) {
        # Drop retransmissions
        if (!t_newtran()) {
            sl_reply_error();
            exit;
        }
        
        # Authenticate via blockchain
        if (!web3_www_authenticate("$fd", "$rm")) {
            auth_challenge("$fd", "0");
            exit;
        }
        
        # Save location and continue
        save("location");
    }
    
    if (is_method("INVITE")) {
        # Drop retransmissions
        if (!t_newtran()) {
            sl_reply_error();
            exit;
        }
        
        # Proxy authenticate
        if (!web3_proxy_authenticate("$fd", "$rm")) {
            proxy_challenge("$fd", "0");
            exit;
        }
    }
}</code></pre>

        <h4>4. Deploy your smart contract:</h4>
        <p>Your authentication contract must implement:</p>
        <pre><code>function authenticateUser(
    string memory username,
    string memory realm,
    string memory method,
    string memory uri,
    string memory nonce,
    uint8 algorithm,
    bytes memory response
) public view returns (bool);

function getWalletAddress(
    string memory username
) public view returns (address);</code></pre>

        <h3>Resources</h3>
        <ul>
          <li><strong>Module:</strong> auth_web3 (compatible with Kamailio and OpenSIPS)</li>
          <li><strong>Authentication Network:</strong> Oasis Sapphire (confidential EVM)</li>
          <li><strong>ENS Network:</strong> Any ENS-compatible chain (Ethereum, Hoodi, etc.)</li>
          <li><strong>Demo Contract:</strong> 0xf4B4d8b8a9b1F104b2100F6d68e1ab21C3a2DF76 (Oasis Sapphire Testnet)</li>
        </ul>
      </div>
    </main>

    </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // Firebase config from environment variables (configured via Vite)
    const firebaseConfig = {
      apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
      authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
      projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
      storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
      messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
      appId: import.meta.env.VITE_FIREBASE_APP_ID,
      measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // Make auth available globally
    window.firebaseAuth = auth;
    window.googleProvider = googleProvider;
    window.signInWithPopup = signInWithPopup;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;
    window.sendSignInLinkToEmail = sendSignInLinkToEmail;
    window.isSignInWithEmailLink = isSignInWithEmailLink;
    window.signInWithEmailLink = signInWithEmailLink;
  </script>
  <script type="module" src="/index.js"></script>
  </body>
</html>
